<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheometry Dash</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* MEN√ö PRINCIPAL */
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
        }

        #logo {
            width: 400px;
            max-width: 80%;
            margin-bottom: 50px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .menu-buttons {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            width: 120px;
            height: 120px;
            background: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 15px;
        }

        .menu-btn:hover {
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .menu-btn:active {
            transform: translateY(-5px) scale(1.05);
        }

        .menu-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #playBtn {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .settings-btn {
            width: 100px;
            height: 100px;
        }

        /* SELECTOR DE NIVELES */
        #levelSelector {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .level-card-container {
            position: relative;
            width: 500px;
            max-width: 90%;
            height: 300px;
        }

        .level-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: none;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .level-card.active {
            display: flex;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .level-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .difficulty-emoji {
            font-size: 40px;
        }

        .level-name {
            font-size: 32px;
            color: #333;
            font-weight: bold;
        }

        .coins-info {
            font-size: 20px;
            color: #666;
            margin-bottom: 20px;
        }

        .progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .progress-label {
            font-size: 16px;
            color: #888;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        .level-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }

        .dot.active {
            background: white;
            transform: scale(1.3);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .nav-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .nav-btn.left {
            left: 20px;
        }

        .nav-btn.right {
            right: 20px;
        }

        .play-level-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-level-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: scale(1.1);
        }

        /* JUEGO 3D */
        #gameCanvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .game-ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }

        .game-over {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 200;
        }

        .game-over h2 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #f5576c;
        }

        .game-over p {
            font-size: 24px;
            margin-bottom: 30px;
            color: #666;
        }

        .restart-btn, .menu-return-btn {
            padding: 15px 40px;
            margin: 0 10px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .menu-return-btn {
            background: #e0e0e0;
            color: #333;
        }

        .restart-btn:hover, .menu-return-btn:hover {
            transform: scale(1.1);
        }

        /* MODAL */
        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1001;
            text-align: center;
            max-width: 500px;
        }

        .modal h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #333;
        }

        .modal p {
            font-size: 18px;
            color: #666;
            line-height: 1.6;
        }

        .close-modal {
            margin-top: 20px;
            padding: 10px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            transform: scale(1.1);
        }
    </style>
</head>
    <!-- EDITOR (CREATE / SEARCH / LIST) -->
<div id="editorPanel" style="display:none; z-index:2000;">
  <div id="editorOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.6);"></div>
  <div id="editorWindow" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:90%; max-width:1000px; height:80vh; background:linear-gradient(180deg,#fff,#f7f7fb); border-radius:20px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,0.4); display:flex; gap:20px;">
    <!-- Sidebar -->
    <aside style="width:320px; padding:20px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg,#f0f4ff,#ffffff);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0">Editor</h3>
        <button id="closeEditor" style="border:none;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;">‚úï</button>
      </div>

      <div>
        <input id="searchInput" placeholder="Buscar niveles por nombre..." style="width:100%; padding:10px; border-radius:10px; border:1px solid #e0e0e0;">
      </div>

      <div style="display:flex; gap:8px;">
        <button id="tabSearch" class="editor-tab" data-tab="search" style="flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;">Buscar</button>
        <button id="tabCreate" class="editor-tab" data-tab="create" style="flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,#f093fb,#f5576c);color:#fff;">Crear</button>
      </div>

      <div id="yourLevelsList" style="flex:1; overflow:auto; border-radius:10px; padding:8px; background:rgba(255,255,255,0.4);">
        <!-- Aqu√≠ se llenan tus niveles locales -->
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="createNewLevelBtn" style="flex:1;padding:12px;border-radius:12px;border:none; cursor:pointer; background:#4a90e2;color:white;">Crear nuevo</button>
        <button id="syncBtn" style="padding:8px;border-radius:10px;border:none;cursor:pointer;">Publicar</button>
      </div>
    </aside>

    <!-- Main area: editor/tester -->
    <main style="flex:1; padding:20px; display:flex; flex-direction:column; gap:12px;">
      <div style="display:flex; gap:12px; align-items:center;">
        <input id="editorLevelName" placeholder="Nombre del nivel" style="flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;">
        <select id="editorDifficulty" style="padding:10px;border-radius:10px;border:1px solid #ddd;">
          <option value="üòä">üòä F√°cil</option>
          <option value="üòê">üòê Medio</option>
          <option value="üò†">üò† Dif√≠cil</option>
          <option value="üò±">üò± Extremo</option>
          <option value="üëπ">üëπ Infernal</option>
        </select>
        <button id="saveLevelBtn" style="padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,#7bd389,#49c3a6);cursor:pointer;color:#fff;">Guardar</button>
        <button id="testLevelBtn" style="padding:10px 16px;border-radius:10px;border:none;background:#333;cursor:pointer;color:#fff;">Test</button>
      </div>

      <div id="editorCanvasArea" style="flex:1; background:#eef2ff; border-radius:12px; display:flex; align-items:center; justify-content:center;">
        <!-- Aqu√≠ se puede renderizar una vista previa simple del nivel / par√°metros -->
        <div id="editorPreview">Vista previa del nivel (mock)</div>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cloneLevelBtn" style="padding:10px 14px;border-radius:10px;border:none;cursor:pointer;">Clonar</button>
        <button id="publishLevelBtn" style="padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#f093fb,#f5576c);cursor:pointer;color:#fff;">Publicar</button>
      </div>

      <div id="editorLog" style="height:80px; overflow:auto; font-size:13px; color:#444; background:#fff; border-radius:8px; padding:8px; border:1px solid #eee;"></div>
    </main>
  </div>
</div>

<body>
    <!-- MEN√ö PRINCIPAL -->
    <div id="menu">
        <img id="logo" src="CheometryDashLogo.png" alt="Cheometry Dash">
        
        <div class="menu-buttons">
            <button class="menu-btn" id="editBtn">
                <img src="Edit.png" alt="Edit">
            </button>
            <button class="menu-btn" id="playBtn">
                <img src="Play.png" alt="Play">
            </button>
        </div>
        
        <div class="menu-buttons">
            <button class="menu-btn settings-btn" id="settingsBtn">
                <img src="Settings.png" alt="Settings">
            </button>
            <button class="menu-btn settings-btn" id="creditsBtn">
                <img src="Credits.png" alt="Credits">
            </button>
        </div>
    </div>

    <!-- SELECTOR DE NIVELES -->
    <div id="levelSelector">
        <button class="back-btn" id="backToMenu">‚Üê Volver</button>
        
        <div class="level-card-container">
            <button class="nav-btn left" id="prevLevel">‚óÄ</button>
            <button class="nav-btn right" id="nextLevel">‚ñ∂</button>
            
            <div id="levelCards"></div>
        </div>
    </div>

    <!-- JUEGO 3D -->
    <div id="gameCanvas"></div>
    <div class="game-ui" id="gameUI">
        <div id="levelNameDisplay"></div>
        <div id="progressDisplay">Progreso: 0%</div>
    </div>

    <!-- GAME OVER -->
    <div class="game-over" id="gameOver">
        <h2 id="gameOverTitle">¬°Fallaste!</h2>
        <p id="gameOverProgress">Progreso: 0%</p>
        <button class="restart-btn" id="restartBtn">Reintentar</button>
        <button class="menu-return-btn" id="menuReturnBtn">Men√∫</button>
    </div>

    <!-- MODAL AJUSTES -->
    <div class="modal" id="settingsModal">
        <h2>‚öôÔ∏è Ajustes</h2>
        <p>Pr√≥ximamente: Control de volumen, efectos visuales y m√°s opciones de personalizaci√≥n.</p>
        <button class="close-modal" id="closeSettings">Cerrar</button>
    </div>

    <!-- MODAL CR√âDITOS -->
    <div class="modal" id="creditsModal">
        <h2>üéÆ Cr√©ditos</h2>
        <p>
            <strong>Cheometry Dash</strong><br><br>
            Desarrollado con ‚ù§Ô∏è<br>
            Motor gr√°fico: Three.js<br>
            Inspirado en Geometry Dash<br><br>
            ¬°Gracias por jugar!
        </p>
        <button class="close-modal" id="closeCredits">Cerrar</button>
    </div>

    <script>
        // DATOS DE NIVELES
        const levels = [
            { name: "Stereo Madness +", difficulty: "üòä", coins: 0, progress: 0, speed: 0.15, obstacles: 15, music: "StereoMadness.mp3" },
            { name: "Pack on Pack", difficulty: "üòä", coins: 0, progress: 0, speed: 0.17, obstacles: 18, music: "PackOnPack.mp3" },
            { name: "Totangeist", difficulty: "üòê", coins: 0, progress: 0, speed: 0.19, obstacles: 22, music: "Totangeist.mp3" },
            { name: "Ply out", difficulty: "üòê", coins: 0, progress: 0, speed: 0.21, obstacles: 25, music: "PlyOut.mp3" },
            { name: "Serm√≥n after Serm√≥n", difficulty: "üòê", coins: 0, progress: 0, speed: 0.23, obstacles: 28, music: "SermonAfterSermon.mp3" },
            { name: "Cant go out", difficulty: "üò†", coins: 0, progress: 0, speed: 0.25, obstacles: 32, music: "CantGoOut.mp3" },
            { name: "Toca C√©sped", difficulty: "üò†", coins: 0, progress: 0, speed: 0.27, obstacles: 35, music: "TocaCesped.mp3" },
            { name: "Time No Machine", difficulty: "üò†", coins: 0, progress: 0, speed: 0.29, obstacles: 38, music: "TimeNoMachine.mp3" },
            { name: "Aqu√≠ no hay Cycles", difficulty: "üò±", coins: 0, progress: 0, speed: 0.31, obstacles: 42, music: "AquiNoHayCycles.mp3" },
            { name: "XNotStep", difficulty: "üò±", coins: 0, progress: 0, speed: 0.33, obstacles: 45, music: "XNotStep.mp3" },
            { name: "PutterFunk", difficulty: "üò±", coins: 0, progress: 0, speed: 0.35, obstacles: 48, music: "PutterFunk.mp3" },
            { name: "Theory of the Big Bang", difficulty: "üò±", coins: 0, progress: 0, speed: 0.37, obstacles: 52, music: "TheoryOfTheBigBang.mp3" },
            { name: "Iker Adventures", difficulty: "üëπ", coins: 0, progress: 0, speed: 0.39, obstacles: 55, music: "IkerAdventures.mp3" },
            { name: "Electropinasticks", difficulty: "üëπ", coins: 0, progress: 0, speed: 0.41, obstacles: 58, music: "Electropinasticks.mp3" },
            { name: "FingerPam", difficulty: "üëπ", coins: 0, progress: 0, speed: 0.43, obstacles: 62, music: "FingerPam.mp3" },
            { name: "Dash", difficulty: "üëπ", coins: 0, progress: 0, speed: 0.5, obstacles: 70, music: "Dash.mp3" }
        ];

        let currentLevelIndex = 0;

        // M√öSICA
        function initMenuMusic() {
            if (!menuMusic) {
                menuMusic = new Audio('Menu.mp3');
                menuMusic.loop = true;
                menuMusic.volume = 0.5;
            }
        }

        function playMenuMusic() {
            initMenuMusic();
            if (levelMusic) {
                levelMusic.pause();
                levelMusic.currentTime = 0;
            }
            menuMusic.play().catch(e => console.log('Error playing menu music:', e));
        }

        function stopMenuMusic() {
            if (menuMusic) {
                menuMusic.pause();
            }
        }

        function playLevelMusic(musicFile) {
            stopMenuMusic();
            if (levelMusic) {
                levelMusic.pause();
            }
            levelMusic = new Audio(musicFile);
            levelMusic.loop = true;
            levelMusic.volume = 0.6;
            levelMusic.play().catch(e => console.log('Error playing level music:', e));
        }

        function stopLevelMusic() {
            if (levelMusic) {
                levelMusic.pause();
                levelMusic.currentTime = 0;
            }
        }

        // CREAR TARJETAS DE NIVELES
        function createLevelCards() {
            const container = document.getElementById('levelCards');
            levels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = 'level-card' + (index === 0 ? ' active' : '');
                card.innerHTML = `
                    <div class="level-header">
                        <span class="difficulty-emoji">${level.difficulty}</span>
                        <span class="level-name">${level.name}</span>
                    </div>
                    <div class="coins-info">ü™ô Monedas: ${level.coins}/3</div>
                    <div class="progress-container">
                        <div class="progress-label">Progreso del nivel</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${level.progress}%">
                                ${level.progress}%
                            </div>
                        </div>
                        <div class="level-dots">
                            ${levels.map((_, i) => `<div class="dot ${i === index ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <button class="play-level-btn" onclick="startLevel(${index})">‚ñ∂ JUGAR</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // NAVEGACI√ìN DE NIVELES
        function showLevel(index) {
            const cards = document.querySelectorAll('.level-card');
            cards.forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });
            currentLevelIndex = index;
        }

        document.getElementById('prevLevel').addEventListener('click', () => {
            currentLevelIndex = (currentLevelIndex - 1 + levels.length) % levels.length;
            showLevel(currentLevelIndex);
        });

        document.getElementById('nextLevel').addEventListener('click', () => {
            currentLevelIndex = (currentLevelIndex + 1) % levels.length;
            showLevel(currentLevelIndex);
        });

        // MEN√ö PRINCIPAL
        document.getElementById('playBtn').addEventListener('click', () => {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('levelSelector').style.display = 'flex';
        });

        document.getElementById('backToMenu').addEventListener('click', () => {
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'block';
        });

        document.getElementById('creditsBtn').addEventListener('click', () => {
            document.getElementById('creditsModal').style.display = 'block';
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'none';
        });

        document.getElementById('closeCredits').addEventListener('click', () => {
            document.getElementById('creditsModal').style.display = 'none';
        });

        // JUEGO 3D CON THREE.JS
        let scene, camera, renderer, player, obstacles = [], ground;
        let gameRunning = false;
        let currentLevel;
        let gameSpeed = 0.1;
        let playerVelocity = 0;
        let isJumping = false;
        let distanceTraveled = 0;
        let levelLength = 100;
        let menuMusic, levelMusic;
        let isMouseDown = false;
        let isKeyDown = false;

        function startLevel(index) {
            currentLevel = levels[index];
            gameSpeed = currentLevel.speed;
            
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('levelNameDisplay').textContent = currentLevel.name;
            
            playLevelMusic(currentLevel.music);
            initGame();
        }

        function initGame() {
            distanceTraveled = 0;
            obstacles = [];
            
            const container = document.getElementById('gameCanvas');
            container.innerHTML = '';

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 10, 50);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.x = 0;
            camera.position.y = 3;
            camera.position.z = 10;
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Luces
            const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 5);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Suelo
            const groundGeo = new THREE.PlaneGeometry(200, 10);
            const groundMat = new THREE.MeshLambertMaterial({ color: 0x4a90e2 });
            ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.x = 50;
            ground.position.y = 0;
            ground.position.z = 0;
            ground.receiveShadow = true;
            scene.add(ground);

            // Jugador (cubo)
            const playerGeo = new THREE.BoxGeometry(1, 1, 1);
            const playerMat = new THREE.MeshLambertMaterial({ color: 0xff6b6b });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.x = -3;
            player.position.y = 0.5;
            player.position.z = 0;
            player.castShadow = true;
            scene.add(player);

            // Crear obst√°culos
            createObstacles();

            gameRunning = true;
            gameLoop();
        }

        function createObstacles() {
            const colors = [0xffd93d, 0x6bcf7f, 0xff6b9d, 0x4ecdc4];
            const minDistance = 4; // Distancia m√≠nima entre obst√°culos (en unidades 3D)
            
            for (let i = 0; i < currentLevel.obstacles; i++) {
                const type = Math.random() > 0.5 ? 'spike' : 'block';
                let obstacle;
                
                if (type === 'spike') {
                    const geo = new THREE.ConeGeometry(0.5, 1.5, 4);
                    const mat = new THREE.MeshLambertMaterial({ color: colors[Math.floor(Math.random() * colors.length)] });
                    obstacle = new THREE.Mesh(geo, mat);
                    obstacle.position.y = 0.75;
                } else {
                    const height = 1 + Math.random() * 2;
                    const geo = new THREE.BoxGeometry(1, height, 1);
                    const mat = new THREE.MeshLambertMaterial({ color: colors[Math.floor(Math.random() * colors.length)] });
                    obstacle = new THREE.Mesh(geo, mat);
                    obstacle.position.y = height / 2;
                }
                
                // Calcular distancia asegurando el m√≠nimo
                const baseDistance = levelLength / currentLevel.obstacles;
                const finalDistance = Math.max(baseDistance, minDistance);
                
                obstacle.position.x = 5 + i * finalDistance;
                obstacle.position.y = obstacle.position.y;
                obstacle.position.z = 0;
                obstacle.castShadow = true;
                scene.add(obstacle);
                obstacles.push(obstacle);
            }
        }

        function gameLoop() {
            if (!gameRunning) return;

            // Mover obst√°culos y suelo hacia la izquierda
            obstacles.forEach(obs => {
                obs.position.x -= gameSpeed;
                
                if (obs.position.x < -15) {
                    obs.position.x = levelLength + 5;
                }

                // Colisi√≥n
                if (checkCollision(player, obs)) {
                    gameOver(false);
                }
            });

            ground.position.x -= gameSpeed;
            if (ground.position.x < -50) {
                ground.position.x = 50;
            }

            // F√≠sica del jugador
            if (isJumping) {
                playerVelocity -= 0.02;
                player.position.y += playerVelocity;

                if (player.position.y <= 0.5) {
                    player.position.y = 0.5;
                    isJumping = false;
                    playerVelocity = 0;
                    
                    // Saltar autom√°ticamente si se mantiene presionado
                    if (isMouseDown || isKeyDown) {
                        isJumping = true;
                        playerVelocity = 0.35;
                    }
                }
            } else {
                // Iniciar salto si se presiona y est√° en el suelo
                if ((isMouseDown || isKeyDown) && player.position.y <= 0.5) {
                    isJumping = true;
                    playerVelocity = 0.35;
                }
            }

            // Rotaci√≥n del jugador
            player.rotation.z += 0.1;

            // Actualizar progreso
            distanceTraveled += gameSpeed;
            const progress = Math.min(Math.floor((distanceTraveled / levelLength) * 100), 100);
            document.getElementById('progressDisplay').textContent = `Progreso: ${progress}%`;

            if (progress >= 100) {
                gameOver(true);
            }

            renderer.render(scene, camera);
            requestAnimationFrame(gameLoop);
        }

        function checkCollision(player, obstacle) {
            const px = player.position.x;
            const py = player.position.y;
            const pz = player.position.z;
            
            const ox = obstacle.position.x;
            const oy = obstacle.position.y;
            const oz = obstacle.position.z;

            return Math.abs(px - ox) < 1 &&
                   Math.abs(py - oy) < 1 &&
                   Math.abs(pz - oz) < 0.5;
        }

        function gameOver(won) {
            gameRunning = false;
            stopLevelMusic();
            
            const progress = Math.floor((distanceTraveled / levelLength) * 100);
            
            if (won) {
                currentLevel.progress = 100;
                document.getElementById('gameOverTitle').textContent = 'üéâ ¬°Nivel Completado!';
            } else {
                if (progress > currentLevel.progress) {
                    currentLevel.progress = progress;
                }
                document.getElementById('gameOverTitle').textContent = 'üí• ¬°Fallaste!';
            }
            
            document.getElementById('gameOverProgress').textContent = `Progreso: ${progress}%`;
            document.getElementById('gameOver').style.display = 'block';
        }

        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOver').style.display = 'none';
            const container = document.getElementById('gameCanvas');
            container.innerHTML = '';
            playLevelMusic(currentLevel.music);
            initGame();
        });

        document.getElementById('menuReturnBtn').addEventListener('click', () => {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('levelSelector').style.display = 'flex';
            
            stopLevelMusic();
            playMenuMusic();
            
            // Actualizar tarjeta del nivel
            const cards = document.querySelectorAll('.level-card');
            const card = cards[currentLevelIndex];
            const progressFill = card.querySelector('.progress-fill');
            progressFill.style.width = currentLevel.progress + '%';
            progressFill.textContent = currentLevel.progress + '%';
        });

        // Control de salto con teclado
        document.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && gameRunning) {
                isKeyDown = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                isKeyDown = false;
            }
        });

        // Control de salto con mouse
        document.addEventListener('mousedown', (e) => {
            if (gameRunning && e.target.tagName !== 'BUTTON') {
                isMouseDown = true;
            }
        });

        document.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        // Control de salto con touch (m√≥viles)
        document.addEventListener('touchstart', (e) => {
            if (gameRunning && e.target.tagName !== 'BUTTON') {
                e.preventDefault();
                isMouseDown = true;
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (gameRunning) {
                e.preventDefault();
                isMouseDown = false;
            }
        }, { passive: false });

        // Responsive
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Inicializar
        createLevelCards();
        
        // Reproducir m√∫sica del men√∫ al cargar
        window.addEventListener('load', () => {
            playMenuMusic();
        });
        
        // Permitir reproducir m√∫sica con cualquier interacci√≥n del usuario
        document.body.addEventListener('click', () => {
            if (document.getElementById('menu').style.display !== 'none') {
                playMenuMusic();
            }
        }, { once: true });
        
const firebaseConfig = {
  apiKey: "AIzaSyBp5c5G0lb_t5mFoK49CXfkLbWlmnRBtfo",
  authDomain: "cheometry-dash.firebaseapp.com",
  projectId: "cheometry-dash",
  storageBucket: "cheometry-dash.firebasestorage.app",
  messagingSenderId: "882791750468",
  appId: "1:882791750468:web:c5c19b5d6d46d2430e9511",
  measurementId: "G-K9BPCEWEJZ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// login anonimo para publicar
auth.signInAnonymously().catch(err => console.warn('Auth anon error', err));

/* ------------------------
   LOCALSTORAGE - claves
   ------------------------ */
const LS_KEY = 'cheometry_data_v1'; // guarda niveles locales y progreso
const LS_COINS = 'cheometry_coins_v1';

/* ------------------------
   Inicializar guardado de niveles (si no existe)
   ------------------------ */
function loadLocalData() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) {
    try {
      const parsed = JSON.parse(raw);
      // combinar progresos con levels existentes (match por name)
      parsed.levels?.forEach(saved => {
        const lvl = levels.find(l => l.name === saved.name);
        if (lvl) {
          lvl.progress = saved.progress ?? lvl.progress;
          lvl.coins = saved.coins ?? lvl.coins;
          // permitir override de par√°metros si guardaste edici√≥n
          if (saved.custom) Object.assign(lvl, saved.custom);
        } else {
          // si hay niveles locales que no existen en la lista original, a√±adirlos
          levels.push(saved);
        }
      });
    } catch (e) { console.error('parse ls error', e); }
  } else {
    // si no hay LS, asegurarnos que todos los niveles tengan coins/progress
    saveLocalData();
  }

  // monedas globales
  const coinsRaw = localStorage.getItem(LS_COINS);
  if (!coinsRaw) localStorage.setItem(LS_COINS, '0');
}

function saveLocalData() {
  const data = {
    levels: levels.map(l => ({
      name: l.name,
      difficulty: l.difficulty,
      coins: l.coins ?? 0,
      progress: l.progress ?? 0,
      speed: l.speed,
      obstacles: l.obstacles,
      music: l.music,
      custom: {
        // guarda s√≥lo campos editables por el usuario
        speed: l.speed,
        obstacles: l.obstacles
      }
    }))
  };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}

/* ------------------------
   Asegurar coins en todos los niveles
   ------------------------ */
levels.forEach(l => {
  if (typeof l.coins === 'undefined') l.coins = 0;
  if (typeof l.progress === 'undefined') l.progress = 0;
});

/* cargar LS al inicio */
loadLocalData();

/* ------------------------
   Editor UI: wiring
   ------------------------ */
function initEditorUI() {
  const editorPanel = document.getElementById('editorPanel');
  const editBtn = document.getElementById('editBtn');
  const closeEditor = document.getElementById('closeEditor');
  const yourList = document.getElementById('yourLevelsList');
  const searchInput = document.getElementById('searchInput');
  const createNewLevelBtn = document.getElementById('createNewLevelBtn');
  const saveLevelBtn = document.getElementById('saveLevelBtn');
  const testLevelBtn = document.getElementById('testLevelBtn');
  const publishLevelBtn = document.getElementById('publishLevelBtn');
  const cloneLevelBtn = document.getElementById('cloneLevelBtn');
  const editorLevelName = document.getElementById('editorLevelName');
  const editorDifficulty = document.getElementById('editorDifficulty');
  const editorLog = document.getElementById('editorLog');

  let editingIndex = null;

  // abrir editor
  editBtn.addEventListener('click', () => {
    editorPanel.style.display = 'block';
    renderYourLevels();
  });

  // cerrar
  closeEditor.addEventListener('click', () => {
    editorPanel.style.display = 'none';
  });

  // crear nuevo nivel (inserta en array y guarda)
  createNewLevelBtn.addEventListener('click', () => {
    const newName = `Nuevo Nivel ${Date.now()}`;
    const newLevel = {
      name: newName,
      difficulty: 'üòä',
      coins: 0,
      progress: 0,
      speed: 0.15,
      obstacles: 10,
      music: ''
    };
    levels.push(newLevel);
    saveLocalData();
    renderYourLevels();
    log('Nivel creado: ' + newName);
  });

  // buscar en la lista
  searchInput.addEventListener('input', (e) => {
    renderYourLevels(e.target.value);
  });

  // seleccionar nivel de la lista para editar / acciones
  function renderYourLevels(filter = '') {
    yourList.innerHTML = '';
    const filtered = levels.filter(l => l.name.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach((lvl, idx) => {
      const el = document.createElement('div');
      el.style.display = 'flex';
      el.style.justifyContent = 'space-between';
      el.style.alignItems = 'center';
      el.style.padding = '8px';
      el.style.borderBottom = '1px solid rgba(0,0,0,0.05)';
      el.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:600">${lvl.name}</div>
          <div style="font-size:12px;color:#666">Dif: ${lvl.difficulty} ¬∑ Monedas: ${lvl.coins} ¬∑ Progreso: ${lvl.progress}%</div>
        </div>
        <div style="display:flex; gap:6px; margin-left:12px;">
          <button class="play-from-list" data-idx="${levels.indexOf(lvl)}" style="padding:6px;border-radius:8px;border:none;cursor:pointer;">‚ñ∂</button>
          <button class="edit-from-list" data-idx="${levels.indexOf(lvl)}" style="padding:6px;border-radius:8px;border:none;cursor:pointer;">‚úé</button>
          <button class="clone-from-list" data-idx="${levels.indexOf(lvl)}" style="padding:6px;border-radius:8px;border:none;cursor:pointer;">‚ßâ</button>
          <button class="publish-from-list" data-idx="${levels.indexOf(lvl)}" style="padding:6px;border-radius:8px;border:none;cursor:pointer;">‚òÅ</button>
        </div>
      `;
      yourList.appendChild(el);
    });

    // a√±adir listeners din√°micos
    $$('.play-from-list', yourList).forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.idx);
        // abrir y jugar nivel desde la UI principal
        startLevel(i);
        editorPanel.style.display = 'none';
      };
    });

    $$('.edit-from-list', yourList).forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.idx);
        editingIndex = i;
        const lvl = levels[i];
        editorLevelName.value = lvl.name;
        editorDifficulty.value = lvl.difficulty;
        log('Editando ' + lvl.name);
      };
    });

    $$('.clone-from-list', yourList).forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.idx);
        cloneLevel(i);
      };
    });

    $$('.publish-from-list', yourList).forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.idx);
        openPublishDialog(i);
      };
    });
  }

  // guardar cambios del editor
  saveLevelBtn.addEventListener('click', () => {
    if (editingIndex === null) {
      log('Selecciona un nivel para guardar (pulsa ‚úé en la lista).');
      return;
    }
    const lvl = levels[editingIndex];
    lvl.name = editorLevelName.value || lvl.name;
    lvl.difficulty = editorDifficulty.value || lvl.difficulty;
    saveLocalData();
    renderYourLevels();
    log('Guardado: ' + lvl.name);
  });

  // testear (abre nivel en modo test)
  testLevelBtn.addEventListener('click', () => {
    if (editingIndex === null) { log('Selecciona un nivel primero.'); return; }
    const i = editingIndex;
    startLevel(i);
    editorPanel.style.display = 'none';
  });

  // clonar
  cloneLevelBtn.addEventListener('click', () => {
    if (editingIndex === null) { log('Selecciona un nivel para clonar.'); return; }
    cloneLevel(editingIndex);
  });

  function cloneLevel(idx) {
    const base = levels[idx];
    // generar nombre CloneX
    const baseName = base.name;
    let n = 1;
    let newName = `${baseName} Clone (${n})`;
    while (levels.some(l => l.name === newName)) {
      n++;
      newName = `${baseName} Clone (${n})`;
    }
    const clone = JSON.parse(JSON.stringify(base));
    clone.name = newName;
    clone.progress = 0;
    clone.coins = 0;
    levels.push(clone);
    saveLocalData();
    renderYourLevels();
    log('Clonado: ' + newName);
  }

  // publicar: abrir di√°logo de emoji/dificultad -> subir a Firestore
  function openPublishDialog(idx) {
    const lvl = levels[idx];
    const emoji = prompt('Elige emoji de dificultad para publicar (por ejemplo üòä, üòê, üò†, üò±, üëπ)', lvl.difficulty);
    if (emoji === null) { log('Publicaci√≥n cancelada'); return; }
    lvl.difficulty = emoji;
    publishLevelToFirebase(idx);
  }

  function publishLevelToFirebase(idx) {
    const lvl = levels[idx];
    const payload = {
      name: lvl.name,
      difficulty: lvl.difficulty,
      speed: lvl.speed,
      obstacles: lvl.obstacles,
      music: lvl.music || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      author: auth.currentUser ? auth.currentUser.uid : 'anonymous'
    };
    db.collection('public_levels').add(payload)
      .then(ref => {
        log('Publicado en Firebase: ' + lvl.name + ' (id: ' + ref.id + ')');
      })
      .catch(err => {
        log('Error publicando: ' + err.message);
      });
  }

  function openEditorForIndex(i) {
    editingIndex = i;
    const lvl = levels[i];
    editorLevelName.value = lvl.name;
    editorDifficulty.value = lvl.difficulty;
    editorPanel.style.display = 'block';
    renderYourLevels();
  }

  function log(msg) {
    const now = new Date().toLocaleTimeString();
    editorLog.innerHTML = `<div>[${now}] ${msg}</div>` + editorLog.innerHTML;
  }

  // Init render
  renderYourLevels();

  // Exponer funciones (√∫til para event binding fuera)
  window.openEditorForIndex = openEditorForIndex;
  window.renderYourLevels = renderYourLevels;
}

document.addEventListener('DOMContentLoaded', () => {
  initEditorUI();
});

/* ------------------------
   INTEGRACI√ìN: actualizar progreso/monedas -> guardar en LS
   Llamar saveLocalData() cada vez que se actualice currentLevel.progress o currency
   ------------------------ */

function awardCoinsForLevel(levelIndex, coinsToAdd=1) {
  levels[levelIndex].coins = (levels[levelIndex].coins || 0) + coinsToAdd;
  // persistir monedas por nivel y global
  saveLocalData();
  let total = parseInt(localStorage.getItem(LS_COINS) || '0', 10);
  total += coinsToAdd;
  localStorage.setItem(LS_COINS, String(total));
}

/* Modifica tu l√≥gica actual en gameOver() y en la UI donde actualices progreso:
   - cuando haya progreso nuevo: asigna currentLevel.progress = nuevoValor; saveLocalData();
   - cuando recojas monedas: awardCoinsForLevel(currentLevelIndex, cantidad)
*/

/* Ejemplo: al completar nivel en gameOver(true) ya estabas poniendo currentLevel.progress = 100;
   a√±ade saveLocalData() justo despu√©s */

    </script>
</body>
</html>
