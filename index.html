<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheometry Dash</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Firebase SDK v8 desde CDN confiable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-database.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-auth.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-storage.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .hidden {
            display: none !important;
        }

        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
        }

        #logo {
            font-size: 72px;
            font-weight: bold;
            color: white;
            text-shadow: 0 10px 20px rgba(0,0,0,0.3);
            margin-bottom: 50px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .menu-buttons {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            width: 120px;
            height: 120px;
            background: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-size: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        #playBtn {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .settings-btn {
            width: 100px;
            height: 100px;
        }

        #levelSelector {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .level-card-container {
            position: relative;
            width: 500px;
            max-width: 90%;
            height: 400px;
        }

        .level-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: none;
            flex-direction: column;
        }

        .level-card.active {
            display: flex;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .level-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .difficulty-emoji {
            font-size: 40px;
        }

        .level-name {
            font-size: 32px;
            color: #333;
            font-weight: bold;
        }

        .coins-info {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        .level-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }

        .dot.active {
            background: white;
            transform: scale(1.3);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .nav-btn:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .nav-btn.left { left: 20px; }
        .nav-btn.right { right: 20px; }

        .play-level-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-level-btn:hover {
            transform: scale(1.05);
        }

        .back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: scale(1.1);
        }

        #gameCanvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .game-ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
            text-align: center;
        }

        .coins-collected {
            font-size: 20px;
            margin-top: 10px;
        }

        .game-over {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 200;
        }

        .game-over h2 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #f5576c;
        }

        .game-over p {
            font-size: 24px;
            margin-bottom: 20px;
            color: #666;
        }

        .restart-btn, .menu-return-btn {
            padding: 15px 40px;
            margin: 0 10px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .menu-return-btn {
            background: #e0e0e0;
            color: #333;
        }

        .restart-btn:hover, .menu-return-btn:hover {
            transform: scale(1.1);
        }

        #editorHub {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 998;
            flex-direction: column;
        }

        .editor-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 80px 30px 30px;
        }

        .editor-tab {
            padding: 15px 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .editor-tab.active {
            background: white;
            color: #667eea;
        }

        .editor-content {
            display: none;
            padding: 20px;
            height: calc(100% - 200px);
            overflow-y: auto;
        }

        .editor-content.active {
            display: block;
        }

        .search-box {
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .search-box input {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .level-item {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-item:hover {
            transform: translateY(-5px);
        }

        .level-item h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .my-levels-list {
            max-width: 800px;
            margin: 0 auto;
        }

        .my-level-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-level-info h3 {
            font-size: 22px;
            color: #333;
        }

        .my-level-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
        }

        .action-btn.play { background: #4ecdc4; }
        .action-btn.edit { background: #ffd93d; color: #333; }
        .action-btn.clone { background: #6bcf7f; }
        .action-btn.publish { background: #f093fb; }
        .action-btn.rename { background: #667eea; }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .create-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .create-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        #levelEditor {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c3e50;
            z-index: 997;
            flex-direction: column;
        }

        .editor-toolbar {
            background: #34495e;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toolbar-btn:hover {
            background: #764ba2;
        }

        .toolbar-btn.success { background: #2ecc71; }
        .toolbar-btn.danger { background: #e74c3c; }

        .level-name-input {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            flex: 1;
            max-width: 300px;
        }

        .editor-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background: linear-gradient(to bottom, #87ceeb 0%, #e0f6ff 100%);
        }

        .editor-grid {
            position: absolute;
            width: 5000px;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .editor-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 5000px;
            height: 50px;
            background: #4a90e2;
        }

        .placed-obstacle {
            position: absolute;
            border-radius: 5px;
            cursor: move;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .placed-obstacle.spike {
            background: #ff6b6b;
            width: 40px;
            height: 40px;
        }

        .placed-obstacle.block {
            background: #4ecdc4;
            width: 50px;
            height: 50px;
        }

        .placed-coin {
            position: absolute;
            width: 30px;
            height: 30px;
            background: gold;
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .obstacle-palette {
            position: absolute;
            right: 20px;
            top: 20px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .obstacle-palette h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .palette-item {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .palette-item:hover {
            transform: scale(1.1);
        }

        .palette-item.spike { background: #ff6b6b; }
        .palette-item.block { background: #4ecdc4; }
        .palette-item.coin { background: gold; color: #333; }

        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 2000;
            text-align: center;
            max-width: 500px;
        }

        .modal h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #333;
        }

        .modal input, .modal select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn:hover {
            transform: scale(1.1);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        /* SISTEMA DE USUARIO */
        .user-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .user-icon:hover {
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .user-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            min-width: 300px;
            z-index: 2001;
        }

        .user-menu.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .user-menu-item {
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .user-menu-item:hover {
            background: #f0f0f0;
        }

        .user-info {
            padding: 15px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 10px;
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        #authModal {
            max-width: 450px;
            width: 90%;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #e0e0e0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #667eea;
            transform: scale(1.15);
        }

        /* Avatar por defecto en la esquina inferior izquierda */
        .avatar-option:last-child {
            grid-column: 1;
        }

        .file-upload {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }

        .file-upload input {
            display: none;
        }
    </style>
</head>
<body>
    <div id="menu">
        <div id="logo">üéÆ CHEOMETRY DASH</div>
        
        <div class="menu-buttons">
            <button class="menu-btn" id="editBtn">‚úèÔ∏è</button>
            <button class="menu-btn" id="playBtn">‚ñ∂Ô∏è</button>
        </div>
        
        <div class="menu-buttons">
            <button class="menu-btn settings-btn" id="settingsBtn">‚öôÔ∏è</button>
            <button class="menu-btn settings-btn" id="creditsBtn">‚ÑπÔ∏è</button>
        </div>
    </div>

    <div id="levelSelector">
        <button class="back-btn" id="backToMenu">‚Üê Volver</button>
        
        <div class="level-card-container">
            <button class="nav-btn left" id="prevLevel">‚óÄ</button>
            <button class="nav-btn right" id="nextLevel">‚ñ∂</button>
            
            <div id="levelCards"></div>
        </div>
        
        <div class="level-dots" id="levelDots"></div>
    </div>

    <div id="editorHub">
        <button class="back-btn" id="backFromEditor">‚Üê Volver</button>
        
        <div class="editor-tabs">
            <button class="editor-tab active" data-tab="search">üîç Buscar Niveles</button>
            <button class="editor-tab" data-tab="create">üìù Mis Niveles</button>
        </div>

        <div class="editor-content active" id="searchContent">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar niveles por nombre...">
            </div>
            <div class="levels-grid" id="searchResults"></div>
        </div>

        <div class="editor-content" id="createContent">
            <div class="my-levels-list" id="myLevelsList"></div>
            <button class="create-btn" id="createNewLevel">+</button>
        </div>
    </div>

    <div id="levelEditor">
        <div class="editor-toolbar">
            <button class="toolbar-btn danger" id="exitEditor">‚Üê Salir</button>
            <input type="text" class="level-name-input" id="editorLevelName" placeholder="Nombre del nivel">
            <button class="toolbar-btn" id="testLevel">‚ñ∂ Probar</button>
            <button class="toolbar-btn success" id="saveLevel">üíæ Guardar</button>
            <button class="toolbar-btn" id="clearAll">üóëÔ∏è Limpiar</button>
        </div>
        
        <div class="editor-canvas" id="editorCanvas">
            <div class="editor-grid"></div>
            <div class="editor-ground"></div>
            <div class="obstacle-palette">
                <h4>Objetos</h4>
                <div class="palette-item spike" data-type="spike">‚ñ≤</div>
                <div class="palette-item block" data-type="block">‚ñ†</div>
                <div class="palette-item coin" data-type="coin">ü™ô</div>
            </div>
        </div>
    </div>

    <div id="gameCanvas"></div>
    <div class="game-ui" id="gameUI">
        <div id="levelNameDisplay"></div>
        <div id="progressDisplay">Progreso: 0%</div>
        <div class="coins-collected" id="coinsDisplay">ü™ô 0/3</div>
    </div>

    <div class="game-over" id="gameOver">
        <h2 id="gameOverTitle">¬°Fallaste!</h2>
        <p id="gameOverProgress">Progreso: 0%</p>
        <p id="gameOverCoins">ü™ô Monedas: 0/3</p>
        <button class="restart-btn" id="restartBtn">Reintentar</button>
        <button class="menu-return-btn" id="menuReturnBtn">Men√∫</button>
    </div>

    <div class="overlay" id="overlay"></div>
    
    <div class="modal" id="publishModal">
        <h2>üì¢ Publicar Nivel</h2>
        <select id="publishDifficulty">
            <option value="üòä">üòä F√°cil</option>
            <option value="üòê">üòê Medio</option>
            <option value="üò†">üò† Dif√≠cil</option>
            <option value="üò±">üò± Imposible</option>
            <option value="üëπ">üëπ Demonio</option>
        </select>
        <div class="modal-buttons">
            <button class="modal-btn primary" id="confirmPublish">Publicar</button>
            <button class="modal-btn secondary" id="cancelPublish">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="renameModal">
        <h2>‚úèÔ∏è Renombrar Nivel</h2>
        <input type="text" id="renameInput" placeholder="Nuevo nombre">
        <div class="modal-buttons">
            <button class="modal-btn primary" id="confirmRename">Guardar</button>
            <button class="modal-btn secondary" id="cancelRename">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <h2>‚öôÔ∏è Ajustes</h2>
        <p>Pr√≥ximamente: Control de volumen, efectos visuales y m√°s opciones de personalizaci√≥n.</p>
        <button class="modal-btn primary" id="closeSettings">Cerrar</button>
    </div>

    <div class="modal" id="creditsModal">
        <h2>üéÆ Cr√©ditos</h2>
        <p><strong>Cheometry Dash</strong><br><br>Desarrollado con ‚ù§Ô∏è<br>Motor gr√°fico: Three.js<br>Inspirado en Geometry Dash<br><br>¬°Gracias por jugar!</p>
        <button class="modal-btn primary" id="closeCredits">Cerrar</button>
    </div>

    <!-- MODAL DE AUTENTICACI√ìN -->
    <div class="modal" id="authModal">
        <h2>üë§ Cuenta de Usuario</h2>
        
        <div class="auth-tabs">
            <button class="auth-tab active" data-form="login">Iniciar Sesi√≥n</button>
            <button class="auth-tab" data-form="register">Registrarse</button>
        </div>

        <!-- FORMULARIO DE LOGIN -->
        <div class="auth-form active" id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="loginBtn">Iniciar Sesi√≥n</button>
                <button class="modal-btn secondary" id="cancelAuth">Cancelar</button>
            </div>
        </div>

        <!-- FORMULARIO DE REGISTRO -->
        <div class="auth-form" id="registerForm">
            <div class="form-group">
                <label>Nombre de Usuario</label>
                <input type="text" id="registerName" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="tu@email.com">
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres">
            </div>
            <div class="form-group">
                <label>Elige tu Avatar</label>
                <div class="avatar-selector">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="avatar-option" data-avatar="avatar1">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" class="avatar-option" data-avatar="avatar2">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Max" class="avatar-option" data-avatar="avatar3">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Luna" class="avatar-option" data-avatar="avatar4">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie" class="avatar-option" data-avatar="avatar5">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mia" class="avatar-option" data-avatar="avatar6">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Leo" class="avatar-option" data-avatar="avatar7">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default" class="avatar-option selected" data-avatar="default">
                </div>
                <div class="file-upload">
                    <label for="customAvatar">üìÅ O sube tu propia imagen</label>
                    <input type="file" id="customAvatar" accept="image/*">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="registerBtn">Registrarse</button>
                <button class="modal-btn secondary" id="cancelAuth2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PERFIL -->
    <div class="modal" id="profileModal">
        <h2>üë§ Mi Perfil</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="profileAvatar" src="" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px;">
            <h3 id="profileName">Usuario</h3>
            <p id="profileEmail" style="color: #666;">email@example.com</p>
        </div>
        <div class="form-group">
            <label>Cambiar Avatar</label>
            <div class="avatar-selector">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="avatar-option profile-avatar" data-avatar="avatar1">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" class="avatar-option profile-avatar" data-avatar="avatar2">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Max" class="avatar-option profile-avatar" data-avatar="avatar3">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Luna" class="avatar-option profile-avatar" data-avatar="avatar4">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie" class="avatar-option profile-avatar" data-avatar="avatar5">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mia" class="avatar-option profile-avatar" data-avatar="avatar6">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Leo" class="avatar-option profile-avatar" data-avatar="avatar7">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default" class="avatar-option profile-avatar" data-avatar="default">
            </div>
            <div class="file-upload">
                <label for="updateAvatar">üìÅ O sube tu propia imagen</label>
                <input type="file" id="updateAvatar" accept="image/*">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn primary" id="saveProfile">Guardar Cambios</button>
            <button class="modal-btn secondary" id="closeProfile">Cerrar</button>
        </div>
    </div>

    <script>
        // Esperar a que Firebase se cargue completamente
        let database = null;
        let auth = null;
        let storage = null;
        let firebaseReady = false;
        let currentUser = null;
        let selectedAvatar = 'default';
        let customAvatarFile = null;

        // Funci√≥n para inicializar Firebase
        function initializeFirebase() {
            try {
                // Verificar que Firebase est√© disponible
                if (typeof firebase === 'undefined') {
                    console.error('‚ùå Firebase SDK no se carg√≥ correctamente');
                    return false;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyBp5c5G0lb_t5mFoK49CXfkLbWlmnRBtfo",
                    authDomain: "cheometry-dash.firebaseapp.com",
                    databaseURL: "https://cheometry-dash-default-rtdb.firebaseio.com",
                    projectId: "cheometry-dash",
                    storageBucket: "cheometry-dash.firebasestorage.app",
                    messagingSenderId: "882791750468",
                    appId: "1:882791750468:web:c5c19b5d6d46d2430e9511",
                    measurementId: "G-K9BPCEWEJZ"
                };

                // Inicializar solo si no existe ya
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();
                storage = firebase.storage();
                firebaseReady = true;
                console.log('‚úÖ Firebase conectado correctamente a:', firebaseConfig.databaseURL);
                
                // Listener de autenticaci√≥n
                auth.onAuthStateChanged(onAuthStateChanged);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                return false;
            }
        }

        // SISTEMA DE AUTENTICACI√ìN - Funciones auxiliares
        function onAuthStateChanged(user) {
            currentUser = user;
            if (user) {
                console.log('üë§ Usuario conectado:', user.email);
                showUserInfo(user);
                loadUserData(user.uid);
            } else {
                console.log('üë§ Usuario desconectado');
                showGuestInfo();
            }
        }

        function showUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            const loginMenuItem = document.getElementById('loginMenuItem');
            const profileMenuItem = document.getElementById('profileMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            
            if (userInfo) userInfo.style.display = 'block';
            if (loginMenuItem) loginMenuItem.style.display = 'none';
            if (profileMenuItem) profileMenuItem.style.display = 'block';
            if (logoutMenuItem) logoutMenuItem.style.display = 'block';
            
            // Cargar avatar y nombre del usuario
            fetch('https://cheometry-dash-default-rtdb.firebaseio.com/users/' + user.uid + '.json')
                .then(res => res.json())
                .then(userData => {
                    const name = userData?.displayName || user.email.split('@')[0];
                    const avatar = userData?.avatar || 'default';
                    
                    const displayName = document.getElementById('displayUserName');
                    const displayEmail = document.getElementById('displayUserEmail');
                    const userAvatar = document.getElementById('userAvatar');
                    
                    if (displayName) displayName.textContent = name;
                    if (displayEmail) displayEmail.textContent = user.email;
                    if (userAvatar) userAvatar.src = getAvatarUrl(avatar);
                })
                .catch(() => {
                    const displayName = document.getElementById('displayUserName');
                    const displayEmail = document.getElementById('displayUserEmail');
                    if (displayName) displayName.textContent = user.email.split('@')[0];
                    if (displayEmail) displayEmail.textContent = user.email;
                });
        }

        function showGuestInfo() {
            const userInfo = document.getElementById('userInfo');
            const loginMenuItem = document.getElementById('loginMenuItem');
            const profileMenuItem = document.getElementById('profileMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userInfo) userInfo.style.display = 'none';
            if (loginMenuItem) loginMenuItem.style.display = 'block';
            if (profileMenuItem) profileMenuItem.style.display = 'none';
            if (logoutMenuItem) logoutMenuItem.style.display = 'none';
            if (userAvatar) userAvatar.src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default';
        }

        function getAvatarUrl(avatar) {
            if (!avatar) return 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default';
            if (avatar.startsWith('http') || avatar.startsWith('data:')) return avatar;
            if (avatar === 'default') return 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default';
            
            const seed = avatar.replace('avatar', '');
            const seeds = ['Felix', 'Aneka', 'Max', 'Luna', 'Charlie', 'Mia', 'Leo'];
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${seeds[parseInt(seed) - 1] || 'Felix'}`;
        }

        async function loadUserData(uid) {
            try {
                const response = await fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${uid}/progress.json`);
                const data = await response.json();
                
                if (data) {
                    Object.keys(data).forEach(levelName => {
                        const level = officialLevels.find(l => l.name === levelName);
                        if (level) {
                            level.progress = data[levelName].progress || 0;
                            level.coins = data[levelName].coins || 0;
                        }
                    });
                    renderLevelCards();
                }
                
                const levelsResponse = await fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${uid}/levels.json`);
                const levelsData = await levelsResponse.json();
                
                if (levelsData) {
                    const myLevels = Object.values(levelsData);
                    localStorage.setItem('myLevels', JSON.stringify(myLevels));
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }

        async function saveUserProgress() {
            if (!currentUser) {
                return;
            }
            
            try {
                const progressData = {};
                officialLevels.forEach(level => {
                    progressData[level.name] = {
                        progress: level.progress,
                        coins: level.coins
                    };
                });
                
                await fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${currentUser.uid}/progress.json`, {
                    method: 'PUT',
                    body: JSON.stringify(progressData)
                });
                
                console.log('üíæ Progreso guardado en Firebase');
            } catch (error) {
                console.error('Error guardando progreso:', error);
            }
        }

        async function uploadCustomAvatar(uid, file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${currentUser.uid}.json`)
                .then(res => res.json())
                .then(userData => {
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profileAvatar = document.getElementById('profileAvatar');
                    
                    if (profileName) profileName.textContent = userData?.displayName || currentUser.email;
                    if (profileEmail) profileEmail.textContent = currentUser.email;
                    if (profileAvatar) profileAvatar.src = userData?.avatar || getAvatarUrl('default');
                    
                    document.getElementById('overlay').style.display = 'block';
                    document.getElementById('profileModal').style.display = 'block';
                });
        }

        // Intentar inicializar Firebase cuando la p√°gina cargue
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (initializeFirebase()) {
                    console.log('üî• Firebase listo para usar');
                } else {
                    console.warn('‚ö†Ô∏è Firebase no disponible, trabajando en modo local');
                }
                initializeUI();
            }, 100);
        });

        function initializeUI() {
            // SISTEMA DE AUTENTICACI√ìN - UI
            const userIcon = document.getElementById('userIcon');
            const userMenu = document.getElementById('userMenu');
            const loginMenuItem = document.getElementById('loginMenuItem');
            const profileMenuItem = document.getElementById('profileMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            
            if (!userIcon || !userMenu) return;

            userIcon.onclick = (e) => {
                e.stopPropagation();
                const overlay = document.getElementById('overlay');
                if (userMenu.style.display === 'block') {
                    userMenu.style.display = 'none';
                    overlay.style.display = 'none';
                } else {
                    userMenu.style.display = 'block';
                    overlay.style.display = 'block';
                }
            };

            // Cerrar men√∫ al hacer click fuera o en el overlay
            const overlay = document.getElementById('overlay');
            overlay.onclick = () => {
                userMenu.style.display = 'none';
                overlay.style.display = 'none';
            };

            document.addEventListener('click', (e) => {
                if (!userIcon.contains(e.target) && !userMenu.contains(e.target)) {
                    userMenu.style.display = 'none';
                    const overlay = document.getElementById('overlay');
                    if (overlay && !document.getElementById('authModal').style.display && 
                        !document.getElementById('profileModal').style.display) {
                        overlay.style.display = 'none';
                    }
                }
            });

            if (loginMenuItem) {
                loginMenuItem.onclick = () => {
                    userMenu.style.display = 'none';
                    document.getElementById('overlay').style.display = 'block';
                    document.getElementById('authModal').style.display = 'block';
                };
            }

            if (profileMenuItem) {
                profileMenuItem.onclick = () => {
                    userMenu.style.display = 'none';
                    showProfileModal();
                };
            }

            if (logoutMenuItem) {
                logoutMenuItem.onclick = () => {
                    if (auth) {
                        auth.signOut().then(() => {
                            alert('üëã Sesi√≥n cerrada exitosamente');
                            userMenu.style.display = 'none';
                            document.getElementById('overlay').style.display = 'none';
                        });
                    }
                };
            }

            // Tabs de autenticaci√≥n
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.form + 'Form').classList.add('active');
                };
            });

            // Selector de avatar
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.onclick = function() {
                    const parent = this.closest('.avatar-selector');
                    parent.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedAvatar = this.dataset.avatar;
                    customAvatarFile = null;
                };
            });

            // Avatar personalizado
            const customAvatarInput = document.getElementById('customAvatar');
            if (customAvatarInput) {
                customAvatarInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        customAvatarFile = file;
                        document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                    }
                };
            }

            // Login
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.onclick = async () => {
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        alert('Por favor completa todos los campos');
                        return;
                    }
                    
                    if (!auth) {
                        alert('‚ùå Autenticaci√≥n no disponible en este entorno');
                        return;
                    }
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        document.getElementById('overlay').style.display = 'none';
                        document.getElementById('authModal').style.display = 'none';
                        alert('‚úÖ Sesi√≥n iniciada exitosamente');
                    } catch (error) {
                        console.error('Error login:', error);
                        alert('‚ùå Error: ' + (error.message || 'No se pudo iniciar sesi√≥n'));
                    }
                };
            }

            // Registro
            const registerBtn = document.getElementById('registerBtn');
            if (registerBtn) {
                registerBtn.onclick = async () => {
                    const name = document.getElementById('registerName').value;
                    const email = document.getElementById('registerEmail').value;
                    const password = document.getElementById('registerPassword').value;
                    
                    if (!name || !email || !password) {
                        alert('Por favor completa todos los campos');
                        return;
                    }
                    
                    if (password.length < 6) {
                        alert('La contrase√±a debe tener al menos 6 caracteres');
                        return;
                    }
                    
                    if (!auth) {
                        alert('‚ùå Autenticaci√≥n no disponible en este entorno');
                        return;
                    }
                    
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // Guardar datos del usuario
                        const avatarUrl = customAvatarFile ? 
                            await uploadCustomAvatar(user.uid, customAvatarFile) : 
                            getAvatarUrl(selectedAvatar);
                        
                        await fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${user.uid}.json`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                displayName: name,
                                avatar: avatarUrl,
                                createdAt: Date.now()
                            })
                        });
                        
                        document.getElementById('overlay').style.display = 'none';
                        document.getElementById('authModal').style.display = 'none';
                        alert('‚úÖ Cuenta creada exitosamente. ¬°Bienvenido!');
                    } catch (error) {
                        console.error('Error registro:', error);
                        alert('‚ùå Error: ' + (error.message || 'No se pudo crear la cuenta'));
                    }
                };
            }

            const saveProfileBtn = document.getElementById('saveProfile');
            if (saveProfileBtn) {
                saveProfileBtn.onclick = async () => {
                    if (!currentUser) return;
                    
                    const selectedProfileAvatar = document.querySelector('.profile-avatar.selected');
                    let newAvatar = selectedProfileAvatar ? selectedProfileAvatar.dataset.avatar : null;
                    
                    const customFile = document.getElementById('updateAvatar').files[0];
                    if (customFile) {
                        newAvatar = await uploadCustomAvatar(currentUser.uid, customFile);
                    }
                    
                    if (newAvatar) {
                        const avatarUrl = newAvatar.startsWith('data:') ? newAvatar : getAvatarUrl(newAvatar);
                        
                        await fetch(`https://cheometry-dash-default-rtdb.firebaseio.com/users/${currentUser.uid}/avatar.json`, {
                            method: 'PUT',
                            body: JSON.stringify(avatarUrl)
                        });
                        
                        document.getElementById('userAvatar').src = avatarUrl;
                        alert('‚úÖ Perfil actualizado');
                    }
                    
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('profileModal').style.display = 'none';
                };
            }

            const closeProfileBtn = document.getElementById('closeProfile');
            if (closeProfileBtn) {
                closeProfileBtn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('profileModal').style.display = 'none';
                };
            }

            const cancelAuthBtn = document.getElementById('cancelAuth');
            if (cancelAuthBtn) {
                cancelAuthBtn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('authModal').style.display = 'none';
                };
            }

            const cancelAuth2Btn = document.getElementById('cancelAuth2');
            if (cancelAuth2Btn) {
                cancelAuth2Btn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('authModal').style.display = 'none';
                };
            }
        }

        const officialLevels = [
            { name: "Stereo Madness +", difficulty: "üòä", coins: 0, progress: 0, speed: 0.15, obstacles: [], coinPositions: [300, 600, 900] },
            { name: "Pack on Pack", difficulty: "üòä", coins: 0, progress: 0, speed: 0.17, obstacles: [], coinPositions: [350, 700, 1050] },
            { name: "Totangeist", difficulty: "üòê", coins: 0, progress: 0, speed: 0.19, obstacles: [], coinPositions: [400, 750, 1100] },
            { name: "Ply out", difficulty: "üòê", coins: 0, progress: 0, speed: 0.21, obstacles: [], coinPositions: [380, 800, 1150] },
            { name: "Serm√≥n after Serm√≥n", difficulty: "üòê", coins: 0, progress: 0, speed: 0.23, obstacles: [], coinPositions: [420, 820, 1200] },
            { name: "Cant go out", difficulty: "üò†", coins: 0, progress: 0, speed: 0.25, obstacles: [], coinPositions: [440, 880, 1280] },
            { name: "Toca C√©sped", difficulty: "üò†", coins: 0, progress: 0, speed: 0.27, obstacles: [], coinPositions: [460, 920, 1320] },
            { name: "Time No Machine", difficulty: "üò†", coins: 0, progress: 0, speed: 0.29, obstacles: [], coinPositions: [480, 960, 1360] },
            { name: "Aqu√≠ no hay Cycles", difficulty: "üò±", coins: 0, progress: 0, speed: 0.31, obstacles: [], coinPositions: [500, 1000, 1400] }
        ];

        let currentLevelIndex = 0;
        let gameState = {
            scene: null,
            camera: null,
            renderer: null,
            player: null,
            obstacles: [],
            coins: [],
            isJumping: false,
            velocity: 0,
            isGameOver: false,
            currentLevel: null,
            collectedCoins: 0
        };

        let editorState = {
            currentLevel: null,
            placedObjects: [],
            selectedType: null
        };

        loadProgress();

        function loadProgress() {
            const saved = JSON.parse(localStorage.getItem('cheometryProgress') || '{}');
            officialLevels.forEach((level, i) => {
                if (saved[level.name]) {
                    level.progress = saved[level.name].progress || 0;
                    level.coins = saved[level.name].coins || 0;
                }
                if (!level.obstacles || level.obstacles.length === 0) {
                    level.obstacles = generateLevelObstacles(i);
                }
            });
        }

        function saveProgress() {
            const data = {};
            officialLevels.forEach(level => {
                data[level.name] = {
                    progress: level.progress,
                    coins: level.coins
                };
            });
            localStorage.setItem('cheometryProgress', JSON.stringify(data));
            
            // Tambi√©n guardar en Firebase si hay usuario
            if (currentUser) {
                saveUserProgress();
            }
        }

        function generateLevelObstacles(levelIndex) {
            const obstacles = [];
            const spacing = 200 + levelIndex * 10;
            const count = 15 + levelIndex * 3;
            
            for (let i = 0; i < count; i++) {
                obstacles.push({
                    type: Math.random() > 0.5 ? 'spike' : 'block',
                    x: 200 + i * spacing + Math.random() * 50,
                    y: 0,
                    width: Math.random() > 0.5 ? 40 : 50,
                    height: Math.random() > 0.5 ? 40 : 50
                });
            }
            return obstacles;
        }

        renderLevelCards();

        function renderLevelCards() {
            const container = document.getElementById('levelCards');
            const dots = document.getElementById('levelDots');
            container.innerHTML = '';
            dots.innerHTML = '';

            officialLevels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = `level-card ${index === currentLevelIndex ? 'active' : ''}`;
                card.innerHTML = `
                    <div class="level-header">
                        <span class="difficulty-emoji">${level.difficulty}</span>
                        <span class="level-name">${level.name}</span>
                    </div>
                    <div class="coins-info">ü™ô ${level.coins}/3</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${level.progress}%">
                                ${level.progress}%
                            </div>
                        </div>
                        <button class="play-level-btn" onclick="startLevel(${index})">¬°JUGAR!</button>
                    </div>
                `;
                container.appendChild(card);

                const dot = document.createElement('div');
                dot.className = `dot ${index === currentLevelIndex ? 'active' : ''}`;
                dots.appendChild(dot);
            });
        }

        document.getElementById('playBtn').onclick = () => {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('levelSelector').style.display = 'flex';
        };

        document.getElementById('backToMenu').onclick = () => {
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        };

        document.getElementById('prevLevel').onclick = () => {
            currentLevelIndex = (currentLevelIndex - 1 + officialLevels.length) % officialLevels.length;
            renderLevelCards();
        };

        document.getElementById('nextLevel').onclick = () => {
            currentLevelIndex = (currentLevelIndex + 1) % officialLevels.length;
            renderLevelCards();
        };

        function startLevel(index) {
            const level = officialLevels[index];
            gameState.currentLevel = level;
            gameState.collectedCoins = 0;
            
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('levelNameDisplay').textContent = level.name;
            
            initGame(level);
        }

        function initGame(level) {
            const container = document.getElementById('gameCanvas');
            container.innerHTML = '';

            gameState.scene = new THREE.Scene();
            gameState.scene.background = new THREE.Color(0x87ceeb);

            gameState.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            gameState.camera.position.set(0, 3, 10);

            gameState.renderer = new THREE.WebGLRenderer({ antialias: true });
            gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(gameState.renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            gameState.scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            gameState.scene.add(directionalLight);

            const groundGeometry = new THREE.BoxGeometry(2000, 0.5, 10);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x4a90e2 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.position.y = -2;
            gameState.scene.add(ground);

            const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
            const playerMaterial = new THREE.MeshStandardMaterial({ color: 0xff6b6b });
            gameState.player = new THREE.Mesh(playerGeometry, playerMaterial);
            gameState.player.position.set(-5, 0, 0);
            gameState.scene.add(gameState.player);

            gameState.obstacles = [];
            level.obstacles.forEach(obs => {
                const geometry = new THREE.BoxGeometry(obs.width / 25, obs.height / 25, 1);
                const material = new THREE.MeshStandardMaterial({ 
                    color: obs.type === 'spike' ? 0xff6b6b : 0x4ecdc4 
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(obs.x / 50 - 5, obs.y / 50, 0);
                mesh.userData = { type: obs.type };
                gameState.scene.add(mesh);
                gameState.obstacles.push(mesh);
            });

            gameState.coins = [];
            level.coinPositions.forEach(x => {
                const geometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16);
                const material = new THREE.MeshStandardMaterial({ color: 0xffd700 });
                const coin = new THREE.Mesh(geometry, material);
                coin.rotation.x = Math.PI / 2;
                coin.position.set(x / 50 - 5, 1, 0);
                coin.userData = { collected: false };
                gameState.scene.add(coin);
                gameState.coins.push(coin);
            });

            gameState.isJumping = false;
            gameState.velocity = 0;
            gameState.isGameOver = false;
            document.getElementById('gameOver').style.display = 'none';

            animate();
        }

        document.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && !gameState.isJumping && !gameState.isGameOver) {
                gameState.isJumping = true;
                gameState.velocity = 0.15;
            }
        });

        document.getElementById('gameCanvas').addEventListener('click', () => {
            if (!gameState.isJumping && !gameState.isGameOver) {
                gameState.isJumping = true;
                gameState.velocity = 0.15;
            }
        });

        function animate() {
            if (gameState.isGameOver) return;

            requestAnimationFrame(animate);

            if (gameState.isJumping) {
                gameState.player.position.y += gameState.velocity;
                gameState.velocity -= 0.008;

                if (gameState.player.position.y <= 0) {
                    gameState.player.position.y = 0;
                    gameState.isJumping = false;
                    gameState.velocity = 0;
                }
            }

            const speed = gameState.currentLevel.speed;
            gameState.obstacles.forEach(obs => {
                obs.position.x -= speed;
                
                if (obs.position.x < -10) {
                    obs.position.x += 50;
                }

                const distance = gameState.player.position.distanceTo(obs.position);
                if (distance < 0.8) {
                    endGame();
                }
            });

            gameState.coins.forEach(coin => {
                coin.position.x -= speed;
                coin.rotation.z += 0.05;
                
                if (!coin.userData.collected) {
                    const distance = gameState.player.position.distanceTo(coin.position);
                    if (distance < 0.8) {
                        coin.userData.collected = true;
                        gameState.scene.remove(coin);
                        gameState.collectedCoins++;
                        document.getElementById('coinsDisplay').textContent = `ü™ô ${gameState.collectedCoins}/3`;
                    }
                }
            });

            gameState.camera.position.x = gameState.player.position.x + 5;

            const progress = Math.min(100, (gameState.camera.position.x / 15) * 100);
            document.getElementById('progressDisplay').textContent = `Progreso: ${Math.floor(progress)}%`;

            if (progress >= 100) {
                winGame();
            }

            gameState.renderer.render(gameState.scene, gameState.camera);
        }

        function endGame() {
            gameState.isGameOver = true;
            const progress = Math.min(100, (gameState.camera.position.x / 15) * 100);
            
            if (progress > gameState.currentLevel.progress) {
                gameState.currentLevel.progress = Math.floor(progress);
            }
            if (gameState.collectedCoins > gameState.currentLevel.coins) {
                gameState.currentLevel.coins = gameState.collectedCoins;
            }
            saveProgress();

            document.getElementById('gameOverTitle').textContent = '¬°Fallaste!';
            document.getElementById('gameOverProgress').textContent = `Progreso: ${Math.floor(progress)}%`;
            document.getElementById('gameOverCoins').textContent = `ü™ô Monedas: ${gameState.collectedCoins}/3`;
            document.getElementById('gameOver').style.display = 'block';
        }

        function winGame() {
            gameState.isGameOver = true;
            gameState.currentLevel.progress = 100;
            if (gameState.collectedCoins > gameState.currentLevel.coins) {
                gameState.currentLevel.coins = gameState.collectedCoins;
            }
            saveProgress();

            document.getElementById('gameOverTitle').textContent = '¬°Victoria!';
            document.getElementById('gameOverProgress').textContent = 'Completado: 100%';
            document.getElementById('gameOverCoins').textContent = `ü™ô Monedas: ${gameState.collectedCoins}/3`;
            document.getElementById('gameOver').style.display = 'block';
        }

        document.getElementById('restartBtn').onclick = () => {
            document.getElementById('gameOver').style.display = 'none';
            initGame(gameState.currentLevel);
        };

        document.getElementById('menuReturnBtn').onclick = () => {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
            renderLevelCards();
        };

        document.getElementById('editBtn').onclick = () => {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('editorHub').style.display = 'flex';
            loadPublishedLevels();
            loadMyLevels();
        };

        document.getElementById('backFromEditor').onclick = () => {
            document.getElementById('editorHub').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        };

        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.editor-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab === 'search' ? 'searchContent' : 'createContent').classList.add('active');
            };
        });

        let publishedLevels = [];

        function loadPublishedLevels() {
            // Intentar cargar desde Firebase REST API
            fetch('https://cheometry-dash-default-rtdb.firebaseio.com/published-levels.json')
                .then(response => response.json())
                .then(data => {
                    publishedLevels = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const level = data[key];
                            
                            // Parsear arrays si est√°n como strings
                            if (level.obstaclesData && typeof level.obstaclesData === 'string') {
                                level.obstacles = JSON.parse(level.obstaclesData);
                                delete level.obstaclesData;
                            }
                            if (level.coinPositionsData && typeof level.coinPositionsData === 'string') {
                                level.coinPositions = JSON.parse(level.coinPositionsData);
                                delete level.coinPositionsData;
                            }
                            
                            publishedLevels.push({
                                id: key,
                                ...level
                            });
                        });
                    }
                    
                    console.log(`üì• Cargados ${publishedLevels.length} niveles desde Firebase`);
                    
                    // Tambi√©n cargar niveles locales
                    const localPublished = JSON.parse(localStorage.getItem('publishedLevels') || '[]');
                    publishedLevels = [...publishedLevels, ...localPublished];
                    
                    renderSearchResults();
                })
                .catch(error => {
                    console.error('Error cargando desde Firebase:', error);
                    // Fallback solo a localStorage
                    const published = JSON.parse(localStorage.getItem('publishedLevels') || '[]');
                    publishedLevels = published;
                    renderSearchResults();
                });
        }

        function renderSearchResults(filter = '') {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            const filtered = publishedLevels.filter(l => 
                l.name.toLowerCase().includes(filter.toLowerCase())
            );

            filtered.forEach(level => {
                const item = document.createElement('div');
                item.className = 'level-item';
                const isLocal = level.id && level.id.startsWith('local_');
                item.innerHTML = `
                    <h3>${level.difficulty} ${level.name}</h3>
                    <p>Por: ${level.author || 'Jugador'} ${isLocal ? '(Local)' : ''}</p>
                    <p style="color: #999; font-size: 14px;">Obst√°culos: ${level.obstacles ? level.obstacles.length : 0} | Monedas: ${level.coinPositions ? level.coinPositions.length : 0}</p>
                `;
                item.onclick = () => playCustomLevel(level);
                container.appendChild(item);
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="color: white; text-align: center; padding: 40px;">
                        <p style="font-size: 24px; margin-bottom: 20px;">üì≠</p>
                        <p>No hay niveles publicados a√∫n.</p>
                        <p style="margin-top: 10px; opacity: 0.8;">¬°S√© el primero en publicar!</p>
                        ${!firebaseReady ? '<p style="margin-top: 20px; color: #ffd93d;">‚ö†Ô∏è Firebase no conectado</p>' : ''}
                    </div>
                `;
            }
        }

        document.getElementById('searchInput').oninput = (e) => {
            renderSearchResults(e.target.value);
        };

        function playCustomLevel(level) {
            gameState.currentLevel = level;
            gameState.collectedCoins = 0;
            
            document.getElementById('editorHub').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('levelNameDisplay').textContent = level.name;
            
            initGame(level);
        }

        function loadMyLevels() {
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            const container = document.getElementById('myLevelsList');
            container.innerHTML = '';

            myLevels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = 'my-level-card';
                card.innerHTML = `
                    <div class="my-level-info">
                        <h3>${level.name}</h3>
                    </div>
                    <div class="my-level-actions">
                        <button class="action-btn play" onclick="playMyLevel(${index})">Jugar</button>
                        <button class="action-btn edit" onclick="editLevel(${index})">Editar</button>
                        <button class="action-btn clone" onclick="cloneLevel(${index})">Clonar</button>
                        <button class="action-btn publish" onclick="publishLevel(${index})">Publicar</button>
                        <button class="action-btn rename" onclick="renameLevel(${index})">Renombrar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.playMyLevel = (index) => {
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            playCustomLevel(myLevels[index]);
        };

        window.editLevel = (index) => {
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            editorState.currentLevel = { index, ...myLevels[index] };
            editorState.placedObjects = myLevels[index].obstacles || [];
            
            document.getElementById('editorHub').style.display = 'none';
            document.getElementById('levelEditor').style.display = 'flex';
            document.getElementById('editorLevelName').value = myLevels[index].name;
            renderEditor();
        };

        window.cloneLevel = (index) => {
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            const original = myLevels[index];
            
            let cloneNumber = 1;
            let newName = `${original.name} Clone ${cloneNumber}`;
            
            while (myLevels.some(l => l.name === newName)) {
                cloneNumber++;
                newName = `${original.name} Clone ${cloneNumber}`;
            }
            
            const clone = { ...original, name: newName };
            myLevels.push(clone);
            localStorage.setItem('myLevels', JSON.stringify(myLevels));
            loadMyLevels();
        };

        let levelToPublish = null;

        // Funci√≥n para eliminar todos los nulls y undefined de un objeto
        function removeNulls(obj) {
            if (obj === null || obj === undefined) {
                return undefined;
            }
            
            if (Array.isArray(obj)) {
                return obj
                    .map(item => removeNulls(item))
                    .filter(item => item !== undefined && item !== null);
            }
            
            if (typeof obj === 'object') {
                const result = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const value = removeNulls(obj[key]);
                        if (value !== undefined && value !== null) {
                            result[key] = value;
                        }
                    }
                }
                return result;
            }
            
            return obj;
        }

        // Funci√≥n para limpiar strings problem√°ticos
        function sanitizeString(str) {
            if (typeof str !== 'string') return str;
            // Eliminar caracteres problem√°ticos pero mantener emojis b√°sicos
            return str.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '').trim();
        }

        window.publishLevel = (index) => {
            try {
                levelToPublish = index;
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('publishModal').style.display = 'block';
            } catch (error) {
                console.error('Error abriendo modal de publicaci√≥n:', error);
                alert('Error al abrir el modal: ' + error.message);
            }
        };

        document.getElementById('confirmPublish').onclick = async () => {
            try {
                console.log('üîÑ Iniciando publicaci√≥n...');
                
                const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
                
                if (levelToPublish === null || levelToPublish === undefined) {
                    throw new Error('No se seleccion√≥ ning√∫n nivel');
                }
                
                const level = myLevels[levelToPublish];
                
                if (!level) {
                    throw new Error('No se encontr√≥ el nivel');
                }
                
                const difficulty = document.getElementById('publishDifficulty').value || 'üòä';
                
                if (!firebaseReady || !database) {
                    throw new Error('Firebase no est√° conectado');
                }
                
                // Crear datos base simples
                const baseData = {
                    name: level.name || 'Nivel sin nombre',
                    difficulty: difficulty,
                    speed: 0.15,
                    publishedAt: Date.now(),
                    author: 'Jugador'
                };
                
                // A√±adir obst√°culos solo si existen
                if (level.obstacles && level.obstacles.length > 0) {
                    baseData.obstacles = level.obstacles.map(obs => ({
                        type: obs.type || 'spike',
                        x: obs.x || 0,
                        y: obs.y || 0,
                        width: obs.width || 40,
                        height: obs.height || 40
                    }));
                } else {
                    baseData.obstacles = [];
                }
                
                // A√±adir monedas solo si existen
                if (level.coinPositions && level.coinPositions.length > 0) {
                    baseData.coinPositions = level.coinPositions.map(c => c || 0);
                } else {
                    baseData.coinPositions = [];
                }
                
                // Limpiar cualquier null que pueda existir
                const publishData = removeNulls(baseData);
                
                console.log('üì§ Datos limpios:', publishData);
                console.log('üìä JSON:', JSON.stringify(publishData));
                
                // M√©todo m√°s b√°sico: convertir a JSON string y parsearlo
                const jsonStr = JSON.stringify(publishData);
                const cleanData = JSON.parse(jsonStr);
                
                // Escribir directamente con set() en un nuevo nodo
                console.log('üî• Creando referencia...');
                const newRef = database.ref('published-levels').push();
                console.log('üìù ID generado:', newRef.key);
                
                console.log('üíæ Guardando datos...');
                
                try {
                    // Usar REST API de Firebase en lugar del SDK
                    const flatData = {
                        name: String(cleanData.name),
                        difficulty: String(cleanData.difficulty),
                        speed: Number(cleanData.speed),
                        publishedAt: Number(cleanData.publishedAt),
                        author: String(cleanData.author),
                        obstacleCount: Number(cleanData.obstacles.length),
                        coinCount: Number(cleanData.coinPositions.length),
                        obstaclesData: JSON.stringify(cleanData.obstacles),
                        coinPositionsData: JSON.stringify(cleanData.coinPositions)
                    };
                    
                    console.log('üì¶ Datos preparados:', flatData);
                    console.log('üåê Usando REST API de Firebase...');
                    console.log('üîó URL:', 'https://cheometry-dash-default-rtdb.firebaseio.com/published-levels.json');
                    
                    // Publicar usando fetch a la REST API
                    const response = await fetch('https://cheometry-dash-default-rtdb.firebaseio.com/published-levels.json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        mode: 'cors',
                        body: JSON.stringify(flatData)
                    });
                    
                    console.log('üì° Respuesta recibida:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Error de respuesta:', errorText);
                        throw new Error('Error HTTP: ' + response.status + ' - ' + errorText);
                    }
                    
                    const result = await response.json();
                    const levelId = result.name; // Firebase devuelve el ID en "name"
                    
                    console.log('‚úÖ Publicado exitosamente con ID:', levelId);
                    
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('publishModal').style.display = 'none';
                    
                    alert('¬°Nivel publicado exitosamente en Firebase! üéâ\n\nID: ' + levelId + '\n\nYa est√° disponible para todos en "Buscar Niveles".');
                    
                    // Recargar niveles publicados
                    loadPublishedLevels();
                    
                } catch (setError) {
                    console.error('‚ö†Ô∏è Error Firebase:', setError);
                    console.error('Mensaje del error:', setError.message);
                    console.error('Stack:', setError.stack);
                    
                    // Verificar si es problema de red
                    if (setError.message.includes('fetch') || setError.message.includes('network')) {
                        console.warn('üåê Problema de conexi√≥n detectado');
                        console.warn('Posibles causas:');
                        console.warn('1. No hay conexi√≥n a internet');
                        console.warn('2. Firebase Realtime Database no est√° activo');
                        console.warn('3. Las reglas de Firebase bloquean el acceso');
                    }
                    
                    console.warn('üìÅ Guardando localmente como alternativa...');
                    
                    // Guardar en localStorage como alternativa
                    cleanData.id = 'local_' + Date.now();
                    const published = JSON.parse(localStorage.getItem('publishedLevels') || '[]');
                    published.push(cleanData);
                    localStorage.setItem('publishedLevels', JSON.stringify(published));
                    
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('publishModal').style.display = 'none';
                    
                    alert('‚ö†Ô∏è Firebase no disponible en este entorno\n\n‚úÖ Nivel PUBLICADO LOCALMENTE\n\nüéÆ Funciona perfectamente:\n- Puedes crear niveles\n- Editar y probar\n- Jugar tus creaciones\n- Compartir el c√≥digo HTML\n\nüí° Para Firebase real:\nDescarga el HTML y √°brelo en tu navegador local');
                    
                    loadPublishedLevels();
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                console.error('Mensaje:', error.message);
                console.error('Tipo:', typeof error);
                console.error('Completo:', JSON.stringify(error, null, 2));
                
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('publishModal').style.display = 'none';
                
                alert('Error al publicar: ' + error.message);
            }
        };

        document.getElementById('cancelPublish').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('publishModal').style.display = 'none';
        };

        let levelToRename = null;

        window.renameLevel = (index) => {
            levelToRename = index;
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            document.getElementById('renameInput').value = myLevels[index].name;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('renameModal').style.display = 'block';
        };

        document.getElementById('confirmRename').onclick = () => {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName) {
                const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
                myLevels[levelToRename].name = newName;
                localStorage.setItem('myLevels', JSON.stringify(myLevels));
                loadMyLevels();
            }
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('renameModal').style.display = 'none';
        };

        document.getElementById('cancelRename').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('renameModal').style.display = 'none';
        };

        document.getElementById('createNewLevel').onclick = () => {
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            let count = myLevels.length + 1;
            let newName = `Nivel ${count}`;
            
            while (myLevels.some(l => l.name === newName)) {
                count++;
                newName = `Nivel ${count}`;
            }
            
            const newLevel = {
                name: newName,
                speed: 0.15,
                obstacles: [],
                coinPositions: []
            };
            
            myLevels.push(newLevel);
            localStorage.setItem('myLevels', JSON.stringify(myLevels));
            
            editLevel(myLevels.length - 1);
        };

        function renderEditor() {
            const canvas = document.getElementById('editorCanvas');
            canvas.querySelectorAll('.placed-obstacle, .placed-coin').forEach(el => el.remove());
            
            editorState.placedObjects.forEach((obj, i) => {
                const el = document.createElement('div');
                el.className = obj.type === 'coin' ? 'placed-coin' : `placed-obstacle ${obj.type}`;
                el.style.left = obj.x + 'px';
                el.style.bottom = obj.y + 'px';
                el.textContent = obj.type === 'spike' ? '‚ñ≤' : (obj.type === 'block' ? '‚ñ†' : 'ü™ô');
                el.draggable = true;
                el.dataset.index = i;
                
                el.ondragstart = (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', i);
                };
                
                el.ondblclick = () => {
                    editorState.placedObjects.splice(i, 1);
                    renderEditor();
                };
                
                canvas.appendChild(el);
            });
        }

        document.querySelectorAll('.palette-item').forEach(item => {
            item.onclick = () => {
                editorState.selectedType = item.dataset.type;
                document.querySelectorAll('.palette-item').forEach(i => i.style.border = 'none');
                item.style.border = '3px solid #667eea';
            };
        });

        document.getElementById('editorCanvas').onclick = (e) => {
            if (!editorState.selectedType || e.target.classList.contains('placed-obstacle') || 
                e.target.classList.contains('placed-coin') || e.target.classList.contains('palette-item')) {
                return;
            }
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left + e.currentTarget.scrollLeft;
            const y = rect.bottom - e.clientY;
            
            const obj = {
                type: editorState.selectedType,
                x: Math.round(x / 50) * 50,
                y: Math.max(0, Math.round(y / 50) * 50),
                width: editorState.selectedType === 'coin' ? 30 : (editorState.selectedType === 'spike' ? 40 : 50),
                height: editorState.selectedType === 'coin' ? 30 : (editorState.selectedType === 'spike' ? 40 : 50)
            };
            
            editorState.placedObjects.push(obj);
            renderEditor();
        };

        document.getElementById('clearAll').onclick = () => {
            if (confirm('¬øSeguro que quieres eliminar todos los objetos?')) {
                editorState.placedObjects = [];
                renderEditor();
            }
        };

        document.getElementById('saveLevel').onclick = () => {
            const name = document.getElementById('editorLevelName').value.trim() || 'Nivel sin nombre';
            const myLevels = JSON.parse(localStorage.getItem('myLevels') || '[]');
            
            const levelData = {
                name,
                speed: 0.15,
                obstacles: editorState.placedObjects.filter(o => o.type !== 'coin'),
                coinPositions: editorState.placedObjects.filter(o => o.type === 'coin').map(c => c.x)
            };
            
            if (editorState.currentLevel && editorState.currentLevel.index !== undefined) {
                myLevels[editorState.currentLevel.index] = levelData;
            } else {
                myLevels.push(levelData);
            }
            
            localStorage.setItem('myLevels', JSON.stringify(myLevels));
            alert('¬°Nivel guardado!');
        };

        document.getElementById('testLevel').onclick = () => {
            const name = document.getElementById('editorLevelName').value.trim() || 'Nivel de prueba';
            const testLevel = {
                name,
                speed: 0.15,
                obstacles: editorState.placedObjects.filter(o => o.type !== 'coin'),
                coinPositions: editorState.placedObjects.filter(o => o.type === 'coin').map(c => c.x),
                difficulty: 'üîß',
                coins: 0,
                progress: 0
            };
            
            document.getElementById('levelEditor').style.display = 'none';
            playCustomLevel(testLevel);
        };

        document.getElementById('exitEditor').onclick = () => {
            document.getElementById('levelEditor').style.display = 'none';
            document.getElementById('editorHub').style.display = 'flex';
            loadMyLevels();
        };

        document.getElementById('settingsBtn').onclick = () => {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('settingsModal').style.display = 'block';
        };

        document.getElementById('closeSettings').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('settingsModal').style.display = 'none';
        };

        document.getElementById('creditsBtn').onclick = () => {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('creditsModal').style.display = 'block';
        };

        document.getElementById('closeCredits').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('creditsModal').style.display = 'none';
        };

        // Iniciar el juego
        console.log('Cheometry Dash cargado correctamente');
    </script>
</body>
    </html>
